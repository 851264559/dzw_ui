<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>职位权限</title>
	</head>

	<body>
		<div id="power" align="center">
			<el-table :data="page.list" border style="width: 70%">
				<el-table-column property="zid" label="岗位编号">
				</el-table-column>
				<el-table-column property="zname" label="岗位名称">
				</el-table-column>
				<el-table-column label="操作">
					<template slot-scope="temp">
						<el-button type="primary" size="mini" @click="showDialog(temp.row.zid)">设置权限</el-button>
					</template>
				</el-table-column>
			</el-table>
			<div class="block">
				<el-pagination layout="prev, pager, next" @current-change="pageChange" :total="page.pages*10">
				</el-pagination>
			</div>

			<div>
				<el-dialog title="权限" :visible.sync="dialogFormVisible">
					<el-tree :data="tree" ref="tree" show-checkbox node-key="id" :default-checked-keys="checkedKeys" :props="tree">
					</el-tree>
					<div slot="footer" class="dialog-footer">
						<el-button @click="dialogFormVisible = false">取 消</el-button>
						<el-button type="primary" @click="savePower">确 定</el-button>
					</div>
				</el-dialog>
			</div>

		</div>
	</body>
	<script>
		var power = new Vue({
			el: "#power",
			data() {
				return {
					page: [],
					tree: [],
					checkedKeys: [],
					dialogFormVisible: false,
				}
			},
			methods: {
				toPerson(p, s) {
					axios.get(`http://127.0.0.1:8080/dzw_sys/ty/api/postb/o/${p}/${s}`).then(resp => {
						this.page = resp.data;
					})
				},
				pageChange(val) {
					this.toPerson(val, this.page.pageSize);
				},
				showDialog(zid) {
					axios.get(`http://127.0.0.1:8080/dzw_sys/api/Functions/${zid}`).then(resp => {
						this.checkedKeys = resp.data;
						this.dialogFormVisible = true;
					});
				},
				savePower() {
					this.checkedKeys = this.$refs.tree.getCheckedKeys();
					let parentKeys = [];
					for(i = 0; i < this.tree.length; i++) {
						parentKeys.push(this.tree[i].id);
					}
					for(i = 0; i < parentKeys.length; i++) {
						for(j = 0; j < this.checkedKeys.length; j++) {
							if(parentKeys[i] == this.checkedKeys[j]) {
								this.checkedKeys.splice(j, 1);
							}
						}
					}
					//					dialogFormVisible = false;
					console.log(this.checkedKeys)
				}
			},
			mounted() {
				this.toPerson(1, 3);
				axios.get(`http://127.0.0.1:8080/dzw_sys/api/Functions`).then(resp => {
					this.tree = resp.data;
				});
			}
		})
	</script>

</html>